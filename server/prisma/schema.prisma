// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------------- 
// --- Enums (所有列舉型別) ---
// ----------------------------------------------- 
enum Role {
  MEMBER
  ORGANIZER
}

enum Provider {
  GOOGLE
  GITHUB
  FACEBOOK
  LINE
  APPLE
  APP
}

enum TargetType {
  USER
  ORGANIZER
  ALL
}

enum NotificationType {
  system
  event
  transaction
  review
  announcement
}

enum TemplateTargetRole {
  user
  ORGANIZER
  ALL
}

enum FavoritableType {
  EVENT
  USER_POST
  ORGANIZER
}

enum ReviewTargetType {
  ORGANIZER
  EVENT
  USER_POST
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventType {
  OFFLINE
  ONLINE
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum CheckInStatus {
  SUCCESS
  DUPLICATE
  INVALID
}

enum TicketStatus {
  valid
  used
}

enum ItemType {
  ticket_types
  products
}

enum OrderStatus {
  pending
  paid
  shipped
  completed
  cancelled
}

enum DeliveryMethod {
  shipping
  on_site_pickup
}

enum PostStatus {
  pending
  approved
  rejected
}


// ----------------------------------------------- 
// --- Models (所有資料模型) ---
// ----------------------------------------------- 

// --- 核心：用戶、組織、管理員 ---

model User {
  id                     String    @id @default(uuid())
  email                  String?   @unique
  password_hash          String?
  role                   Role
  is_active              Boolean   @default(true)
  password_reset_token   String?
  password_reset_expires DateTime?
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt
  name                   String
  avatar                 String?
  phone_number           String?
  birth_date             DateTime?
  address                String?

  providers       UserProvider[]
  organizer       Organizer?
  notifications   UserNotificationStatus[]
  favorites       UserFavorite[]
  scannedCheckIns CheckIn[]
  eventRatings    EventRating[]
  cart            Cart?
  orders          Order[]
  posts           UserPost[]
  postReviews     PostReview[]

  @@map("users")
}

model UserProvider {
  id            String   @id @default(uuid())
  user_id       String
  provider      Provider
  provider_id   String
  access_token  String?  @db.Text // Token 可能很長，建議用 Text
  refresh_token String?  @db.Text
  linked_at     DateTime
  is_primary    Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id])

  @@unique([provider, provider_id])
  @@index([user_id])

  @@map("user_providers")
}

model Organizer {
  id              String    @id @default(uuid())
  user_id         String    @unique
  org_name        String?
  org_address     String?
  org_phone       String?
  org_tax_id      String?
  org_description String?   @db.Text // [修改] 允許長描述
  is_verified     Boolean   @default(false)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  user   User    @relation(fields: [user_id], references: [id])
  events Event[]

  @@map("organizers")
}

model Admin {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  password_hash String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  sentNotifications            Notification[]
  createdNotificationTemplates NotificationTemplate[]
  reviews                      Review[]
  createdAnnouncements         Announcement[]
  
  @@map("admins")
}

// --- 核心：系統功能 (通知, 審核, 公告) ---

model Notification {
  id                Int       @id @default(autoincrement())
  template_id       String?
  sender_admin_id   String?
  target_type       TargetType @default(USER)
  target_id         String?
  type              NotificationType
  title             String
  message           String    @db.Text // [修改] 通知內容可能較長
  event_id          Int?
  link_url          String?
  sent_at           DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  senderAdmin  Admin?                 @relation(fields: [sender_admin_id], references: [id])
  template     NotificationTemplate?  @relation(fields: [template_id], references: [id])
  userStatuses UserNotificationStatus[]

  @@index([template_id])
  @@index([sender_admin_id])
  @@index([target_id])
  @@index([event_id])

  @@map("notifications")
}

model UserNotificationStatus {
  id              Int       @id @default(autoincrement())
  notification_id Int
  user_id         String
  is_read         Boolean   @default(false)
  read_at         DateTime?
  is_deleted      Boolean   @default(false)
  deleted_at      DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  notification Notification @relation(fields: [notification_id], references: [id])
  user         User         @relation(fields: [user_id], references: [id])

  @@index([notification_id])
  @@index([user_id])

  @@map("user_notification_statuses")
}

model NotificationTemplate {
  id           String             @id @default(uuid())
  title        String
  message      String             @db.Text // [修改]
  type         NotificationType
  target_role  TemplateTargetRole @default(ALL)
  is_active    Boolean            @default(true)
  scheduled_at DateTime?
  created_by   String
  created_at   DateTime           @default(now())
  updated_at   DateTime           @updatedAt

  createdByAdmin Admin          @relation(fields: [created_by], references: [id])
  notifications  Notification[]

  @@index([created_by])

  @@map("notification_templates")
}

model UserFavorite {
  id               Int             @id @default(autoincrement())
  user_id          String
  favoritable_id   String
  favoritable_type FavoritableType
  created_at       DateTime        @default(now())
  updated_at       DateTime        @updatedAt

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([favoritable_id, favoritable_type])

  @@map("user_favorites")
}

model Review {
  id          Int              @id @default(autoincrement())
  target_type ReviewTargetType
  target_id   String
  status      ReviewStatus     @default(PENDING)
  reviewed_by String?
  reviewed_at DateTime?
  reason      String?          @db.Text // [修改] 審核理由可能較長
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt

  reviewedByAdmin Admin? @relation(fields: [reviewed_by], references: [id])

  @@index([reviewed_by])
  @@index([target_id, target_type])

  @@map("reviews")
}

model Announcement {
  id            String    @id @default(uuid())
  title         String
  subtitle      String?
  content       String    @db.Text // [修改] 公告內容通常很長
  link_url      String?
  start_date    DateTime
  end_date      DateTime
  display_order Int       @default(0)
  is_active     Boolean   @default(true)
  created_by    String
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  createdByAdmin Admin               @relation(fields: [created_by], references: [id])
  images         AnnouncementImage[]

  @@index([created_by])

  @@map("announcements")
}

model AnnouncementImage {
  id              BigInt   @id @default(autoincrement())
  announcement_id String
  image_url       String
  is_cover        Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  announcement Announcement @relation(fields: [announcement_id], references: [id])

  @@index([announcement_id])

  @@map("announcement_images")
}


// ----------------------------------------------- 
// --- 核心：活動 (Events) ---
// ----------------------------------------------- 

model Event {
  id               Int          @id @default(autoincrement())
  organizer_id     String
  title            String
  subtitle         String?
  description      String       @db.Text // [★修改重點] 這裡改為 Text 即可存長文章
  cover_image      String
  start_time       DateTime
  end_time         DateTime
  location_name    String
  address          String
  latitude         Decimal
  longitude        Decimal
  status           EventStatus
  event_type       EventType
  online_event_url String?
  category_id      Int
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  organizer    Organizer       @relation(fields: [organizer_id], references: [id])
  category     Category        @relation(fields: [category_id], references: [id])
  guests       EventGuest[]
  ticketTypes  TicketType[]
  attachments  EventAttachment[]
  productLinks EventsProducts[]
  tags         EventTag[]
  ratings      EventRating[]
  images       EventImage[]
  relatedPosts UserPost[]

  @@index([organizer_id])
  @@index([category_id])

  @@map("events")
}

model EventGuest {
  id        Int      @id @default(autoincrement())
  event_id  Int
  name      String
  bio       String   @db.Text // [修改] 嘉賓介紹可能較長
  photo_url String

  event Event @relation(fields: [event_id], references: [id])

  @@index([event_id])

  @@map("event_guests")
}

model EventAttachment {
  id        Int      @id @default(autoincrement())
  event_id  Int
  file_name String
  file_url  String

  event Event @relation(fields: [event_id], references: [id])

  @@index([event_id])

  @@map("event_attachments")
}

// ----------------------------------------------- 
// --- 核心：商城與結帳 (Products, Cart, Order) ---
// ----------------------------------------------- 

model Product {
  id            Int      @id @default(autoincrement())
  name          String
  description   String?  @db.Text // [修改] 商品描述
  base_price    Decimal
  image_url     String?
  is_published  Boolean  @default(false)

  variants      ProductVariant[]
  eventLinks    EventsProducts[]

  @@map("products")
}

model ProductVariant {
  id             Int      @id @default(autoincrement())
  product_id     Int
  sku            String?  @unique
  option1_name   String?
  option1_value  String?
  option2_name   String?
  option2_value  String?
  price_offset   Decimal  @default(0)
  stock_quantity Int      @default(0)

  product      Product     @relation(fields: [product_id], references: [id])
  cartItems    CartItem[]
  orderItems   OrderItem[]

  @@index([product_id])

  @@map("productVariant")
}

model EventsProducts {
  event_id   Int
  product_id Int

  event   Event   @relation(fields: [event_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])

  @@id([event_id, product_id])

  @@map("events_products")
}

model Cart {
  id         Int      @id @default(autoincrement())
  user_id    String   @unique
  updated_at DateTime @updatedAt

  user  User       @relation(fields: [user_id], references: [id])
  items CartItem[]

  @@map("cart")
}

model CartItem {
  id                   Int      @id @default(autoincrement())
  cart_id              Int
  item_type            ItemType
  ticket_type_id       String?
  product_variant_id   Int?
  quantity             Int
  added_at             DateTime @default(now())

  cart           Cart           @relation(fields: [cart_id], references: [id])
  ticketType     TicketType?    @relation(fields: [ticket_type_id], references: [id])
  productVariant ProductVariant? @relation(fields: [product_variant_id], references: [id])

  @@index([cart_id])
  @@index([ticket_type_id])
  @@index([product_variant_id])

  @@map("cartItem")
}

model Order {
  id                Int            @id @default(autoincrement())
  order_number      String         @unique
  user_id           String
  discount_amount   Decimal        @default(0)
  coupon_id         String?
  coupon_code       String?
  status            OrderStatus
  billing_name      String
  billing_phone     String
  billing_email     String
  billing_address   String?
  payment_method    String?
  created_at        DateTime       @default(now())
  expires_at        DateTime
  delivery_method   DeliveryMethod?
  subtotal          Decimal
  total_amount      Decimal

  user   User      @relation(fields: [user_id], references: [id])
  coupon Coupon?   @relation(fields: [coupon_id], references: [id])
  items  OrderItem[]

  @@index([user_id])
  @@index([coupon_id])

  @@map("order")
}

model OrderItem {
  id                  Int       @id @default(autoincrement())
  order_id            Int
  item_type           ItemType
  ticket_type_id      String?
  product_variant_id  Int?
  item_name           String
  variant_description String?
  quantity            Int
  unit_price          Decimal

  order        Order         @relation(fields: [order_id], references: [id])
  ticketType   TicketType?   @relation(fields: [ticket_type_id], references: [id])
  productVariant ProductVariant? @relation(fields: [product_variant_id], references: [id])
  ticket       Ticket?

  @@index([order_id])
  @@index([ticket_type_id])
  @@index([product_variant_id])

  @@map("orderItem")
}


// ----------------------------------------------- 
// --- 核心：票務 (Tickets) ---
// ----------------------------------------------- 

model TicketType {
  id              String   @id @default(uuid())
  event_id        Int
  name            String
  price           Decimal
  total_quantity  Int
  sale_start_time DateTime
  sale_end_time   DateTime

  event      Event       @relation(fields: [event_id], references: [id])
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@index([event_id])

  @@map("ticket_types")
}

model Coupon {
  id            String       @id @default(uuid())
  code          String       @unique
  discount_type DiscountType
  value         Decimal
  event_id      Int?
  expires_at    DateTime
  usage_limit   Int
  
  Order Order[]

  @@index([event_id])

  @@map("coupons")
}

model Ticket {
  id            Int      @id @default(autoincrement())
  order_item_id Int      @unique
  name          String
  email         String
  phone         String
  gender        String?
  qr_code_data  String   @unique
  status        String

  orderItem OrderItem @relation(fields: [order_item_id], references: [id])
  checkIn   CheckIn?

  @@map("ticket")
}

model CheckIn {
  id         Int           @id @default(autoincrement())
  ticket_id  Int           @unique
  scanner_id String
  scan_time  DateTime?
  status     CheckInStatus

  ticket  Ticket @relation(fields: [ticket_id], references: [id])
  scanner User   @relation(fields: [scanner_id], references: [id])

  @@index([scanner_id])

  @@map("check_ins")
}


// ----------------------------------------------- 
// --- 核心：分類 (Categories) & 社群 (Posts) ---
// ----------------------------------------------- 

model Category {
  id        Int       @id @default(autoincrement())
  name      String
  parent_id Int?

  parent   Category?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children Category[] @relation("CategoryHierarchy")
  events   Event[]

  @@index([parent_id])

  @@map("categories")
}

model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique

  eventLinks EventTag[]

  @@map("tags")
}

model EventTag {
  event_id Int
  tag_id   Int

  event Event @relation(fields: [event_id], references: [id])
  tag   Tag   @relation(fields: [tag_id], references: [id])

  @@id([event_id, tag_id])

  @@map("event_tags")
}

model EventRating {
  id         Int      @id @default(autoincrement())
  event_id   Int
  user_id    String
  rating     Int
  comment    String?  @db.Text // [修改] 評價內容
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  event Event @relation(fields: [event_id], references: [id])
  user  User  @relation(fields: [user_id], references: [id])

  @@unique([user_id, event_id], name: "uq_user_event_rating")
  
  @@index([event_id])

  @@map("event_rating")
}

model Image {
  id        Int     @id @default(autoincrement())
  image_url String?

  eventLinks EventImage[]

  @@map("images")
}

model EventImage {
  event_id Int
  image_id Int

  event Event @relation(fields: [event_id], references: [id])
  image Image @relation(fields: [image_id], references: [id])

  @@id([event_id, image_id])

  @@map("event_images")
}

model UserPost {
  id           Int        @id @default(autoincrement())
  author_id    String
  title        String
  content      String     @db.Text // [修改] 投稿內容
  category_id  Int
  status       PostStatus @default(pending)
  created_at   DateTime   @default(now())
  published_at DateTime?
  
  article_id   Int?

  author       User          @relation(fields: [author_id], references: [id])
  category     PostCategory  @relation(fields: [category_id], references: [id])
  images       PostImage[]
  tags         ContactTag[]
  reviews      PostReview[]
  
  relatedEvent Event?        @relation(fields: [article_id], references: [id])

  @@index([author_id])
  @@index([category_id])
  @@index([article_id])

  @@map("user_posts")
}

model PostImage {
  id         Int      @id @default(autoincrement())
  post_id    Int
  image_url  String
  is_cover   Boolean  @default(false)
  created_at DateTime @default(now())

  post UserPost @relation(fields: [post_id], references: [id])

  @@index([post_id])

  @@map("post_images")
}

model PostCategory {
  id   Int    @id @default(autoincrement())
  name String

  posts UserPost[]

  @@map("post_categories")
}

model PostTag {
  id   Int    @id @default(autoincrement())
  name String

  posts ContactTag[]

  @@map("post_tags")
}

model ContactTag {
  post_id Int
  tag_id  Int

  post UserPost @relation(fields: [post_id], references: [id])
  tag  PostTag  @relation(fields: [tag_id], references: [id])

  @@id([post_id, tag_id])

  @@index([tag_id])

  @@map("contact_tags")
}

model PostReview {
  id         Int      @id @default(autoincrement())
  post_id    Int
  user_id    String
  content    String   @db.Text // [修改]
  rating     Int
  created_at DateTime @default(now())

  post UserPost @relation(fields: [post_id], references: [id])
  user User     @relation(fields: [user_id], references: [id])

  @@index([post_id])
  @@index([user_id])

  @@map("post_reviews")
}